<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palo Alto NGFW Exam Prep</title>
    <style>
        :root {
            --primary: #fa4616;
            --bg: #f5f7f9;
            --card-bg: #ffffff;
            --text: #2c3e50;
            --success: #27ae60;
            --error: #e74c3c;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        header {
            background-color: var(--primary);
            color: white;
            width: 100%;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .container {
            max-width: 800px;
            width: 90%;
            margin: 20px auto;
        }
        .card {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        button {
            background-color: white;
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        button:hover {
            background-color: var(--primary);
            color: white;
        }
        .option-btn {
            display: block;
            width: 100%;
            text-align: left;
            margin-bottom: 10px;
            border-color: #ddd;
            color: var(--text);
            font-weight: normal;
        }
        .option-btn.correct {
            background-color: var(--success);
            color: white;
            border-color: var(--success);
        }
        .option-btn.incorrect {
            background-color: var(--error);
            color: white;
            border-color: var(--error);
        }
        #explanation {
            margin-top: 20px;
            padding: 15px;
            background: #eef2f7;
            border-radius: 8px;
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #ddd;
            border-radius: 5px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        #progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s;
        }
        .hidden { display: none; }
        .result-pass { color: var(--success); font-weight: bold; font-size: 24px; }
        .result-fail { color: var(--error); font-weight: bold; font-size: 24px; }
        .review-item {
            border-left: 4px solid var(--error);
            padding-left: 15px;
            margin-bottom: 25px;
            background: #fffafa;
            padding-top: 10px;
            padding-bottom: 10px;
        }
    </style>
</head>
<body>

<header>
    <h1>Palo Alto NGFW Exam Simulator</h1>
</header>

<div class="container">
    <!-- Menu Screen -->
    <div id="menu-screen" class="card">
        <h2>Select Exam Mode</h2>
        <div class="menu-grid">
            <button onclick="startExam(0, 60)">Group 1 (1-60)</button>
            <button onclick="startExam(60, 120)">Group 2 (61-120)</button>
            <button onclick="startExam(120, 180)">Group 3 (121-180)</button>
            <button onclick="startExam(180, 240)">Group 4 (181-240)</button>
            <button onclick="startExam(240, 300)">Group 5 (241-300)</button>
            <button onclick="startExam('random')">Random 60</button>
            <button onclick="startExam('all')" style="grid-column: span 2;">Full Marathon (300)</button>
        </div>
    </div>

    <!-- Exam Screen -->
    <div id="exam-screen" class="hidden">
        <div class="progress-bar"><div id="progress-fill"></div></div>
        <div class="card">
            <div id="domain-label" style="font-size: 14px; color: #7f8c8d; margin-bottom: 5px;"></div>
            <h3 id="question-text"></h3>
            <div id="options-container"></div>
            <div id="explanation">
                <strong id="feedback-text"></strong><br>
                <span id="explanation-text"></span>
                <br><br>
                <button onclick="nextQuestion()" style="width: 100%;">Next Question</button>
            </div>
        </div>
    </div>

    <!-- Result Screen -->
    <div id="result-screen" class="hidden">
        <div class="card" style="text-align: center;">
            <h2>Exam Results</h2>
            <div id="score-text" style="font-size: 48px; margin: 20px 0;"></div>
            <div id="pass-fail-text"></div>
            <button onclick="location.reload()" style="margin-top: 20px;">Return to Menu</button>
        </div>
        <div id="review-container" class="card">
            <h3>Review Wrong Answers</h3>
            <div id="review-list"></div>
        </div>
    </div>
</div>

<script>
    let allQuestions = [];
    let currentQuestions = [];
    let currentIndex = 0;
    let score = 0;
    let wrongAnswers = [];
    let answered = false;

    // Load data
    const urlParams = new URLSearchParams(window.location.search);
    
    // Try to load from localStorage first
    const cachedData = localStorage.getItem('palo_questions');
    if (cachedData) {
        try {
            allQuestions = JSON.parse(cachedData);
            console.log("Loaded " + allQuestions.length + " questions from localStorage.");
        } catch (e) {
            console.error("Error parsing cached data", e);
            localStorage.removeItem('palo_questions');
        }
    }

    if (allQuestions.length > 0 && !urlParams.has('debug')) {
        // Data already loaded from cache
        console.log("Using cached questions.");
    } else if (urlParams.has('debug')) {
        console.log("Debug mode: Force manual upload UI");
        setTimeout(showManualUploadUI, 100);
    } else {
        console.log("Attempting to fetch questions.json...");
        fetch('questions.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                allQuestions = data;
                console.log("Loaded " + allQuestions.length + " questions.");
                // Cache it for next time
                localStorage.setItem('palo_questions', JSON.stringify(data));
            })
            .catch(error => {
                console.error('Error loading questions:', error);
                if (allQuestions.length === 0) {
                    showManualUploadUI();
                }
            });
    }

    function showManualUploadUI() {
        document.getElementById('menu-screen').innerHTML = `
            <div id="upload-container" style="padding: 20px; border: 2px solid #3498db; border-radius: 8px; background-color: #ebf5fb;">
                <h3 style="color: #2980b9; margin-top: 0;">ðŸ“± iPad / Mobile Instructions</h3>
                <p>To run this simulation on your device, you need to load the question database.</p>
                <ol style="text-align: left; line-height: 1.6;">
                    <li>If you AirDropped or copied both <strong>index.html</strong> and <strong>questions.json</strong> to your device:</li>
                    <li>Tap the button below and select the <strong>questions.json</strong> file from your Files app.</li>
                </ol>
                <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <label for="file-input" style="display: block; margin-bottom: 10px; font-weight: bold; color: var(--primary);">Step 1: Select Database File</label>
                    <input type="file" id="file-input" accept=".json" style="width: 100%; font-size: 16px;">
                    <div id="upload-status" style="margin-top: 10px; font-weight: bold;"></div>
                </div>
                <hr style="margin: 20px 0; border: 0; border-top: 1px solid #bdc3c7;">
                <p style="font-size: 14px; color: #7f8c8d;"><strong>Technical Note:</strong> Browsers prevent automatic loading of local files for security. Manually selecting the file bypasses this restriction. Once loaded, it will be saved on this device.</p>
            </div>
        `;
        document.getElementById('file-input').addEventListener('change', handleFileUpload);
    }

    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const status = document.getElementById('upload-status');
        status.innerText = "Processing...";
        status.style.color = "orange";

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (Array.isArray(data) && data.length > 0) {
                    allQuestions = data;
                    localStorage.setItem('palo_questions', e.target.result);
                    status.innerText = "Success! Loading menu...";
                    status.style.color = "green";
                    setTimeout(renderMenu, 1000);
                } else {
                    throw new Error("Invalid question format");
                }
            } catch (err) {
                status.innerText = "Error: " + err.message;
                status.style.color = "red";
                alert("Error parsing JSON file: " + err.message);
            }
        };
        reader.onerror = function() {
            status.innerText = "Error reading file";
            status.style.color = "red";
        };
        reader.readAsText(file);
    }

    function renderMenu() {
        document.getElementById('menu-screen').innerHTML = `
            <h2>Select Exam Mode</h2>
            <div class="menu-grid">
                <button onclick="startExam(0, 60)">Group 1 (1-60)</button>
                <button onclick="startExam(60, 120)">Group 2 (61-120)</button>
                <button onclick="startExam(120, 180)">Group 3 (121-180)</button>
                <button onclick="startExam(180, 240)">Group 4 (181-240)</button>
                <button onclick="startExam(240, 300)">Group 5 (241-300)</button>
                <button onclick="startExam('random')">Random 60</button>
                <button onclick="startExam('all')" style="grid-column: span 2;">Full Marathon (300)</button>
            </div>
        `;
    }

    function startExam(start, end) {
        if (allQuestions.length === 0) {
            alert("Questions are still loading or failed to load. Please check the error message on the screen.");
            return;
        }
        if (start === 'random') {
            currentQuestions = [...allQuestions].sort(() => 0.5 - Math.random()).slice(0, 60);
        } else if (start === 'all') {
            currentQuestions = [...allQuestions].sort(() => 0.5 - Math.random());
        } else {
            currentQuestions = allQuestions.slice(start, end);
        }
        
        currentIndex = 0;
        score = 0;
        wrongAnswers = [];
        document.getElementById('menu-screen').classList.add('hidden');
        document.getElementById('exam-screen').classList.remove('hidden');
        showQuestion();
    }

    function showQuestion() {
        answered = false;
        const q = currentQuestions[currentIndex];
        document.getElementById('progress-fill').style.width = ((currentIndex / currentQuestions.length) * 100) + '%';
        document.getElementById('domain-label').innerText = `Question ${currentIndex + 1} of ${currentQuestions.length} | ${q.domain}`;
        document.getElementById('question-text').innerText = q.question;
        
        const container = document.getElementById('options-container');
        container.innerHTML = '';
        document.getElementById('explanation').style.display = 'none';

        for (let key in q.options) {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = `${key.toUpperCase()}) ${q.options[key]}`;
            btn.onclick = () => selectOption(key, btn);
            container.appendChild(btn);
        }
    }

    function selectOption(key, btn) {
        if (answered) return;
        answered = true;
        const q = currentQuestions[currentIndex];
        const buttons = document.querySelectorAll('.option-btn');
        
        if (key === q.answer) {
            btn.classList.add('correct');
            document.getElementById('feedback-text').innerText = 'CORRECT! âœ…';
            document.getElementById('feedback-text').style.color = 'var(--success)';
            score++;
        } else {
            btn.classList.add('incorrect');
            document.getElementById('feedback-text').innerText = 'INCORRECT âŒ';
            document.getElementById('feedback-text').style.color = 'var(--error)';
            
            // Highlight correct one
            buttons.forEach(b => {
                if (b.innerText.startsWith(q.answer.toUpperCase() + ')')) {
                    b.classList.add('correct');
                }
            });

            wrongAnswers.push({
                question: q.question,
                options: q.options,
                userAnswer: key,
                correctAnswer: q.answer,
                explanation: q.explanation
            });
        }

        document.getElementById('explanation-text').innerText = q.explanation;
        document.getElementById('explanation').style.display = 'block';
    }

    function nextQuestion() {
        currentIndex++;
        if (currentIndex < currentQuestions.length) {
            showQuestion();
        } else {
            showResults();
        }
    }

    function showResults() {
        document.getElementById('exam-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');
        
        const percent = (score / currentQuestions.length) * 100;
        document.getElementById('score-text').innerText = `${score} / ${currentQuestions.length} (${percent.toFixed(1)}%)`;
        
        const pf = document.getElementById('pass-fail-text');
        if (percent >= 70) {
            pf.innerHTML = '<span class="result-pass">Result: PASS! ðŸŽ“</span>';
        } else {
            pf.innerHTML = '<span class="result-fail">Result: FAIL. Keep studying! ðŸ“š</span>';
        }

        const reviewList = document.getElementById('review-list');
        reviewList.innerHTML = '';
        if (wrongAnswers.length === 0) {
            document.getElementById('review-container').classList.add('hidden');
        } else {
            wrongAnswers.forEach((wa, i) => {
                const div = document.createElement('div');
                div.className = 'review-item';
                div.innerHTML = `
                    <strong>${i+1}. ${wa.question}</strong><br>
                    <span style="color: var(--error)">Your answer: ${wa.userAnswer.toUpperCase()}) ${wa.options[wa.userAnswer]}</span><br>
                    <span style="color: var(--success)">Correct answer: ${wa.correctAnswer.toUpperCase()}) ${wa.options[wa.correctAnswer]}</span><br>
                    <p><em>Explanation: ${wa.explanation}</em></p>
                `;
                reviewList.appendChild(div);
            });
        }
    }
</script>

</body>
</html>
